# Reverse proxy for Synapse
Было ли у вас когда-нибудь ощущение, что за вами следят? Если вы выводили свой сервер децентрализованного мессенджера [Matrix](https://hub.docker.com/r/matrixdotorg/synapse) в сеть - ничего удивительного. Скорее всего, так и есть.   

Только тот, у кого логи уходят в `> /dev/null 2>&1`, может не заметить регулярного сканирования любого сервера, выведенного в сеть. 

И тут нам на помощь приходит наука. Наука о грамотной настройке того, что мы уже имеем.  

Представляю вашему вниманию набор конфигов, призванный усложнить жизнь сканерам, и сделать ваш Matrix-сервер невидимым для сети. Ну, почти невидимым.

## Что это такое и с чем его едят?
Как и было сказано, это набор конфигов. Считайте комплект для запуска Synapse в компании certbot и reverse-proxy на nginx со строгими правилами безопасности, без которых открывать 80 и 443 порты я опасался.  

Конфигурация составлялась по политике "Бей своих, чтобы чужие боялись". Этакая политика нулевой толерантности, согласно которой мы считаем, что пользователь **обязан** знать, как обращаться к серверу. И любая попытка выйти за рамки использования Synapse или ACME-челленджей для сертификации расценивается как вредоносное сканирование.  
Да-да, за `GET /` у нас полагается бан.

## Как это использовать?
Проще простого *(с третьей или четвёртой попытки)*. Для начала клонируем репозиторий:  
```bash
git clone repo.com/blabla.git
```
После нам необходимо ручками *(спасибо за это nginx, который не поддерживает переменные окружения)* заменить в конфигах `your-domain-here.com` на ваш реальный домен. В частности это нужно сделать в:
`matrix.conf`, `cert.conf`, `docker-compose.yml`  

Далее поднимаем контейнер с certbot для получения первого сертификата:  
```bash
docker-compose up -d certbot
docker exec matrix-certbot certonly --standalone --email your-email@here.com --agree-tos --no-eff-email -d your-domain-here.com --non-interactive
docker-compose down
```
И, наконец, поднимаем всё окружение - 
```bash
docker-compose up -d
```  
Если удача была на вашей стороне и все сервисы стартовали - поздравляю, дальше остаётся только открыть порты 80 и 443, если по умолчанию они закрыты, и перенаправить на вашу хост-машину.  
А дальше используйте Synapse по его прямому назначению.

## Особенности конфигурации
1. Лимиты защиты от ддоса статичные. Если у вас крупный сервер, заполненный любителями отправлять по 1 слову в сообщении каждые пол секунды, возможно придётся расширять лимиты в `jail.local` и `nginx.conf`. 
2. Логи корректного доступа `access.log` дублируются - одна копия как и по умолчанию в nginx:alpine пишется в stdout для удобства просмотра логов через docker logs, вторая в монтированный на хост файл в той же директории, аналогично с `intruders.log`. Это не баг, это фича. Для удобства парсинга логов через fail2ban, а также для лёгкого подключения ротации логов на хосте.